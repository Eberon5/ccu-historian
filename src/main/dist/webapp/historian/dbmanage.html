<% 
import mdz.hc.DataPoint
try {
include 'skeleton-header.html'
def ctx=request.session.getAttribute('ctx')

def dataPoints
def msg=''
if (ctx.user.loggedIn) { 
	dataPoints=database.dataPoints
	if (params.save) {
		def changedIds=[]
		dataPoints.each { dp ->
			def disabled=(params."disabled_$dp.idx"=='1')
			def hidden=(params."hidden_$dp.idx"=='1')
		    def oldFlags=dp.managementFlags
		    dp.historyDisabled=disabled
		    dp.historyHidden=hidden
			if (oldFlags!=dp.managementFlags) {
			    database.updateDataPoint dp
			    changedIds << dp.idx
			}
		}
		if (changedIds) 
			msg+='<p>Folgende Datenpunkte wurden aktualisiert: '+changedIds.join(', ')+'</p>'
	}
}

%><title>CCU-Historian: Verwaltung Datenpunkte</title>
<script src="TableFilter/tablefilter_all_min.js" type="text/javascript"></script><% 
include 'skeleton-menu.html'
include 'skeleton-content.html'
%><h1>Verwaltung Datenpunkte</h1><%

if (!ctx.user.loggedIn) { 
	%><p class="bad">Sie sind nicht (mehr) angemeldet oder Ihre Berechtigungen reichen nicht aus!</p>
	<p><a href="index.html">Zur Anmeldung</a></p><% 
} else {
	println msg 
	%><form action="dbmanage.html" method="post">	
	<table><tr><th>Aktion</th><td><input name="save" type="submit" value=" &Auml;nderungen speichern "></td></tr></table>
	<table id="datapoints">
		<thead><tr>
			<th>Schnittstelle</th>		
			<th>Kanal</th>
			<th>Parameter</th>
			<th style="width:3em">ID</th>
			<th>Eintr&auml;ge</th>
			<th>Inaktiv</th>
			<th>Versteckt</th>
		</tr></thead><tbody><%
	dataPoints.each {
		%><tr>
			<td><%=utils.escapeHtml(it.id.interfaceId)%></td>
			<td><%=utils.escapeHtml(it.attributes.displayName?:it.id.address)%></td>
			<td><%=utils.escapeHtml(it.id.identifier)%></td>
			<td class="number"><%=it.idx%></td>
			<td class="number"><%=database.getCount(it)%></td>
			<td><input type="checkbox" name="disabled_<%=it.idx%>" value="1"<%=it.historyDisabled?' checked="checked"':''%>/></td>
			<td><input type="checkbox" name="hidden_<%=it.idx%>" value="1"<%=it.historyHidden?' checked="checked"':''%>/></td>
		</tr><%
		} 
	%></tbody></table>
	</form>
	<script type="text/javascript">  
		var tf_props={
				filters_row_index: 1,
				display_all_text: " [ Alle ]",
				col_0: "select",
				col_2: "select",
				col_4: "none",
				col_5: "none",
				col_6: "none",
				col_number_format: [null, null, null, "eu", null, null, null],
				on_keyup: true,  
                on_keyup_delay: 500,
				sort: true,
				sort_config: { sort_types: ["string", "string", "string", "eu", "none", "none", "none"] }	
		}
		setFilterGrid("datapoints", tf_props);  
    </script><% 
}
include 'skeleton-end.html' 
} catch (Throwable t) { t.printStackTrace(out) }
%>